import{r as p,u as N,a as U,_ as C,j as m,F as v,S as D,B as F,b as I,g as k}from"./components-37VnnLPw.js";var o;(function(r){r.LOAD="LOAD",r.EXEC="EXEC",r.FFPROBE="FFPROBE",r.WRITE_FILE="WRITE_FILE",r.READ_FILE="READ_FILE",r.DELETE_FILE="DELETE_FILE",r.RENAME="RENAME",r.CREATE_DIR="CREATE_DIR",r.LIST_DIR="LIST_DIR",r.DELETE_DIR="DELETE_DIR",r.ERROR="ERROR",r.DOWNLOAD="DOWNLOAD",r.PROGRESS="PROGRESS",r.LOG="LOG",r.MOUNT="MOUNT",r.UNMOUNT="UNMOUNT"})(o||(o={}));const B=(()=>{let r=0;return()=>r++})(),P=new Error("ffmpeg is not loaded, call `await ffmpeg.load()` first"),T=new Error("called FFmpeg.terminate()");class j{#t=null;#a={};#r={};#o=[];#s=[];loaded=!1;#n=()=>{this.#t&&(this.#t.onmessage=({data:{id:e,type:t,data:a}})=>{switch(t){case o.LOAD:this.loaded=!0,this.#a[e](a);break;case o.MOUNT:case o.UNMOUNT:case o.EXEC:case o.FFPROBE:case o.WRITE_FILE:case o.READ_FILE:case o.DELETE_FILE:case o.RENAME:case o.CREATE_DIR:case o.LIST_DIR:case o.DELETE_DIR:this.#a[e](a);break;case o.LOG:this.#o.forEach(n=>n(a));break;case o.PROGRESS:this.#s.forEach(n=>n(a));break;case o.ERROR:this.#r[e](a);break}delete this.#a[e],delete this.#r[e]})};#e=({type:e,data:t},a=[],n)=>this.#t?new Promise((f,d)=>{const l=B();this.#t&&this.#t.postMessage({id:l,type:e,data:t},a),this.#a[l]=f,this.#r[l]=d,n?.addEventListener("abort",()=>{d(new DOMException(`Message # ${l} was aborted`,"AbortError"))},{once:!0})}):Promise.reject(P);on(e,t){e==="log"?this.#o.push(t):e==="progress"&&this.#s.push(t)}off(e,t){e==="log"?this.#o=this.#o.filter(a=>a!==t):e==="progress"&&(this.#s=this.#s.filter(a=>a!==t))}load=({classWorkerURL:e,...t}={},{signal:a}={})=>(this.#t||(this.#t=e?new Worker(new URL(e,import.meta.url),{type:"module"}):new Worker(new URL("/bendor/assets/worker-BAOIWoxA.js",import.meta.url),{type:"module"}),this.#n()),this.#e({type:o.LOAD,data:t},void 0,a));exec=(e,t=-1,{signal:a}={})=>this.#e({type:o.EXEC,data:{args:e,timeout:t}},void 0,a);ffprobe=(e,t=-1,{signal:a}={})=>this.#e({type:o.FFPROBE,data:{args:e,timeout:t}},void 0,a);terminate=()=>{const e=Object.keys(this.#r);for(const t of e)this.#r[t](T),delete this.#r[t],delete this.#a[t];this.#t&&(this.#t.terminate(),this.#t=null,this.loaded=!1)};writeFile=(e,t,{signal:a}={})=>{const n=[];return t instanceof Uint8Array&&n.push(t.buffer),this.#e({type:o.WRITE_FILE,data:{path:e,data:t}},n,a)};mount=(e,t,a)=>{const n=[];return this.#e({type:o.MOUNT,data:{fsType:e,options:t,mountPoint:a}},n)};unmount=e=>{const t=[];return this.#e({type:o.UNMOUNT,data:{mountPoint:e}},t)};readFile=(e,t="binary",{signal:a}={})=>this.#e({type:o.READ_FILE,data:{path:e,encoding:t}},void 0,a);deleteFile=(e,{signal:t}={})=>this.#e({type:o.DELETE_FILE,data:{path:e}},void 0,t);rename=(e,t,{signal:a}={})=>this.#e({type:o.RENAME,data:{oldPath:e,newPath:t}},void 0,a);createDir=(e,{signal:t}={})=>this.#e({type:o.CREATE_DIR,data:{path:e}},void 0,t);listDir=(e,{signal:t}={})=>this.#e({type:o.LIST_DIR,data:{path:e}},void 0,t);deleteDir=(e,{signal:t}={})=>this.#e({type:o.DELETE_DIR,data:{path:e}},void 0,t)}var b;(function(r){r.MEMFS="MEMFS",r.NODEFS="NODEFS",r.NODERAWFS="NODERAWFS",r.IDBFS="IDBFS",r.WORKERFS="WORKERFS",r.PROXYFS="PROXYFS"})(b||(b={}));const G=new Error("failed to get response body reader"),W=new Error("failed to complete download"),$="Content-Length",M=async(r,e)=>{const t=await fetch(r);let a;try{const n=parseInt(t.headers.get($)||"-1"),f=t.body?.getReader();if(!f)throw G;const d=[];let l=0;for(;;){const{done:E,value:s}=await f.read(),i=s?s.length:0;if(E){if(n!=-1&&n!==l)throw W;e&&e({url:r,total:n,received:l,delta:i,done:E});break}d.push(s),l+=i,e&&e({url:r,total:n,received:l,delta:i,done:E})}const u=new Uint8Array(l);let h=0;for(const E of d)u.set(E,h),h+=E.length;a=u.buffer}catch(n){console.log("failed to send download progress event: ",n),a=await t.arrayBuffer()}return a},A=async(r,e,t=!1,a)=>{const n=t?await M(r,a):await(await fetch(r)).arrayBuffer(),f=new Blob([n],{type:e});return URL.createObjectURL(f)},Q={framerate:15,compressionQuality:0,colorRange:80},Y=()=>{const r=p.useRef(new j),e=p.useRef(null),t=p.useRef(!1),{state:a,dispatch:n}=N(),{start:f,stop:d}=U(),[l,u]=p.useState(Q);p.useEffect(()=>{t.current||(f(),(async()=>{try{const s="https://unpkg.com/@ffmpeg/core@0.12.6/dist/esm";await r.current.load({coreURL:await A(`${s}/ffmpeg-core.js`,"text/javascript"),wasmURL:await A(`${s}/ffmpeg-core.wasm`,"application/wasm")}),console.info("ffmpeg loaded");const i=await C(()=>import("./gifsicle.min-DlEdYrSW.js"),[]);e.current=i.default,console.info("gifsicle loaded"),t.current=!0}catch(s){console.error("Failed to load libraries:",s)}finally{d()}})())},[f,d]);const h=async s=>{if(!e.current)return console.warn("gifsicle not loaded, skipping compression"),s;try{const i=new File([s],"temp.gif",{type:"image/gif"}),g=["-O1",`--lossy=${l.compressionQuality*2}`,`--colors=${l.colorRange}`,"temp.gif","-o","/out/compressed.gif","--no-warnings"],R=await e.current.run({input:[{file:i,name:"temp.gif"}],command:[g.join(" ")]});return R&&R.length>0?R[0]:s}catch(i){return console.error("GIF compression failed:",i),s}},E=async()=>{if(!t.current){console.warn("Libraries not loaded yet");return}if(f(),!a.imgCtx)return;const s=r.current;if(!s.loaded){console.warn("cant export, ffmpeg is not loaded");return}const i=[],g=()=>new Promise((c,L)=>{a.imgCtx?.canvas.toBlob(y=>{y?c(y):L(new Error("Failed to capture frame"))})});i.push(await g()),n({type:I.ResetImageCanvas});for(let c=0;c<11;c++)n({type:I.ResetImageCanvas}),n({type:I.GenerateResult,payload:{refreshIdx:c}}),i.push(await g());for(let c=0;c<i.length;c++){const L=await i[c].arrayBuffer();await s.writeFile(`frame${c.toString().padStart(3,"0")}.png`,new Uint8Array(L))}await s.exec(["-framerate",`${l.framerate}`,"-i","frame%03d.png","-vf",`split[s0][s1];[s0]palettegen=max_colors=${l.colorRange}[p];[s1][p]paletteuse=dither=bayer:bayer_scale=5`,"output.gif"]);const R=await s.readFile("output.gif");let w=new Blob([R.slice(0)],{type:"image/gif"});w=await h(w);const S=await w.arrayBuffer(),x=await k(S),_=URL.createObjectURL(w),O=document.createElement("a");O.href=_,O.download=`${x}.gif`,O.click(),URL.revokeObjectURL(_),d();for(let c=0;c<i.length;c++)await s.deleteFile(`frame${c.toString().padStart(3,"0")}.png`);await s.deleteFile("output.gif")};return m.jsxs(v,{direction:"col",children:[m.jsx(D,{label:"GIF Frame Rate",id:"framerate",min:5,max:30,value:l.framerate,onChange:s=>u(i=>({...i,framerate:parseFloat(s.target.value)}))}),m.jsx(D,{label:"Color Range",id:"colorRange",min:80,max:256,value:l.colorRange,onChange:s=>u(i=>({...i,colorRange:parseFloat(s.target.value)}))}),m.jsx(D,{label:"Quality",id:"compressionQuality",min:0,max:100,value:l.compressionQuality,onChange:s=>u(i=>({...i,compressionQuality:parseFloat(s.target.value)}))}),m.jsx(F,{$full:!0,onClick:E,disabled:!t.current,children:t.current?"Export":"Loading..."})]})};export{Y as default};
